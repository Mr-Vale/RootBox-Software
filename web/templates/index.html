<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>RootBox Control</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <div class="container">
    <h2>üå± RootBox Scanner Controller</h2>

    <!-- Status -->
    <p>Status:
      {% if running %}
        <span class="text-success fw-bold">Running ‚úÖ</span>
      {% else %}
        <span class="text-danger fw-bold">Stopped ‚ùå</span>
      {% endif %}
    </p>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="alert alert-info">
          {% for category, message in messages %}
            <div>{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Settings Form -->
    <form method="post" action="{{ url_for('index') }}">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>Scanner</th>
            <th>Label</th>
            <th>Enabled</th>
            <th>Interval (min)</th>
            <th>Resolution</th>
            <th>Device</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for scanner_id, config in scanners.items() %}
          <tr class="{% if config.device in duplicate_devices and config.device %}table-danger{% endif %}">
            <td><strong>{{ scanner_id.replace('scanner', 'Scanner ') }}</strong></td>
            <td><input type="text" name="label_{{ scanner_id }}" value="{{ config.label }}" class="form-control" required></td>
            <td class="text-center">
              <input type="checkbox" name="enabled_{{ scanner_id }}" {% if config.enabled %}checked{% endif %}>
            </td>
            <td><input type="number" name="interval_{{ scanner_id }}" value="{{ config.interval_minutes }}" class="form-control" min="1" required></td>
            <td>
              <select name="res_{{ scanner_id }}" class="form-select" required>
                {% for value in [600, 300, 150] %}
                  <option value="{{ value }}" {% if config.resolution == value %}selected{% endif %}>{{ value }} dpi</option>
                {% endfor %}
              </select>
            </td>
            <td>
              <select name="device_{{ scanner_id }}" class="form-select">
                <option value="">-- Select Device --</option>
                {% for device in available_devices %}
                  <option value="{{ device }}" {% if device == config.device %}selected{% endif %}>{{ device }}</option>
                {% endfor %}
              </select>
            </td>
            <td>
              <button type="button" class="btn btn-sm btn-primary" onclick="manualScan('{{ scanner_id }}')">Manual Scan</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <button type="submit" class="btn btn-primary">üíæ Save Settings</button>
    </form>

    <!-- Start/Stop Controls -->
    <div class="mt-4">
      <form method="post" action="{{ url_for('start') }}" class="d-inline-block me-2">
        <button type="submit" class="btn btn-success">‚ñ∂ Start Controller</button>
      </form>
      <form method="post" action="{{ url_for('stop') }}" class="d-inline-block">
        <button type="submit" class="btn btn-danger">‚èπ Stop Controller</button>
      </form>
    </div>

    <!-- Log Viewer Accordion -->
    <div class="accordion mt-5" id="logAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingLog">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLog" aria-expanded="false" aria-controls="collapseLog">
            üìÑ View Log (last 50 lines)
          </button>
        </h2>
        <div id="collapseLog" class="accordion-collapse collapse" aria-labelledby="headingLog" data-bs-parent="#logAccordion">
          <div class="accordion-body">
            <pre id="logContent" class="bg-light p-3 border rounded" style="max-height: 400px; overflow-y: auto;">Loading log...</pre>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function manualScan(scannerId) {
      fetch(`/manual_scan/${scannerId}`, {
        method: 'POST'
      }).then(() => location.reload());
    }

    let logInterval = null;

    function loadLog() {
      fetch('/log')
        .then(res => res.text())
        .then(text => {
          document.getElementById('logContent').textContent = text;
        });
    }

    const logCollapse = document.getElementById('collapseLog');

    logCollapse.addEventListener('shown.bs.collapse', function () {
      loadLog();
      logInterval = setInterval(loadLog, 30000); // 30 sec refresh
    });

    logCollapse.addEventListener('hidden.bs.collapse', function () {
      clearInterval(logInterval);
    });
  </script>
</body>
</html>
